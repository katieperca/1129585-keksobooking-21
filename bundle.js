(()=>{"use strict";window.server={loadData:(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(o,n.response):t("Cтатус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},uploadData:(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?t(n.response):o()})),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)}},(()=>{const e={ENTER:13,ESC:27,MOUSE_MAIN_BUTTON:0},t={WIDTH:65,HEIGHT:82,PINTIP_HEIGHT:17},o=document.querySelector(".map"),n=o.querySelector(".map__pin--main"),r=o.querySelector(".map__pins"),i=n.offsetLeft,a=n.offsetTop,d=(e,t)=>{const o=e+Math.random()*(t+1-e);return Math.floor(o)},s=e=>e[Math.floor(Math.random()*e.length)];window.util={KeyCode:e,MainPinParam:t,isEnterEvent:(t,o)=>{t.keyCode===e.ENTER&&o()},isEscEvent:(t,o)=>{t.keyCode===e.ESC&&o()},isMouseMainButtonEvent:(t,o)=>{t.button===e.MOUSE_MAIN_BUTTON&&o()},getRandomInteger:d,getRandomValue:s,getRandomArray:e=>{const t=[],o=e.slice(),n=d(1,e.length);for(let e=0;e<n;e++){const e=Math.floor(Math.random()*o.length);t.push(o[e]),o.splice(e,1)}return t},getRandomTitle:()=>{const e=["дом","барак","сарай","дворец","хлев"],t=["для самоизоляции","в заросшем парке","с жутко злым дедом","с площадкой для барбекю","для уточки Медведева"];return[s(["Уютный","Заброшенный","Проклятый старый","Старинный","Комфортный"]),s(e),s(t)].join(" ")},getMainPinCoords:()=>{let e,r;return o.classList.contains("map--faded")?(e=Math.floor(n.offsetLeft+n.offsetWidth/2),r=Math.floor(n.offsetTop+n.offsetHeight/2)):(e=Math.floor(n.offsetLeft+n.offsetWidth/2),r=Math.floor(n.offsetTop+n.offsetHeight+t.PINTIP_HEIGHT)),e+", "+r},setMainPinCenter:()=>{n.style.left=i+"px",n.style.top=a+"px"},clearMap:()=>{window.card.removeCard(),window.pin.removePins()},renderData:e=>{window.pin.renderPins(r,e.slice(0,5))}}})(),window.debounce=e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#address"),o=e.querySelector("#room_number"),n=e.querySelector("#capacity"),r=e.querySelector("#timein"),i=e.querySelector("#timeout"),a=e.querySelector("#type"),d=e.querySelector("#price"),s=document.querySelector("main"),c={1:[1],2:[1,2],3:[1,2,3],100:[0]},l={bungalow:0,flat:1e3,house:5e3,palace:1e4},u=e=>{t.value=e},m=e=>{const t=n.querySelectorAll("option");t.forEach((e=>{e.disabled=!0})),c[e].forEach((e=>{t.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))},p=e=>{r.value=e.target.value,i.value=e.target.value};r.addEventListener("change",p),i.addEventListener("change",p),a.addEventListener("change",(()=>{d.placeholder=l[a.value],d.setAttribute("min",l[a.value])})),o.addEventListener("change",(()=>{m(o.value)}));const w=()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);s.appendChild(e);const t=()=>{e.remove()};document.addEventListener("click",t),document.addEventListener("keydown",(e=>{window.util.isEscEvent(e,t)}))},f=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=()=>{e.remove()};s.appendChild(e),e.querySelector(".error__button").addEventListener("click",t),e.addEventListener("click",t),document.addEventListener("keydown",(e=>{window.util.isEscEvent(e,t)}))},y=()=>{window.main.deactivatePage(),window.util.clearMap(),window.filter.resetFilters(),window.uploadPhoto.resetImages(),window.util.setMainPinCenter(),e.reset(),u(window.util.getMainPinCoords())};e.addEventListener("submit",(t=>{t.preventDefault(),window.server.uploadData(new FormData(e),w,f),y()})),e.addEventListener("reset",(()=>{y()})),window.form={deactivateForm:e=>{Array.from(e).forEach((e=>{e.setAttribute("disabled","disabled")}))},activateForm:e=>{Array.from(e).forEach((e=>{e.removeAttribute("disabled")}))},setAddressField:u,checkRooms:m,inAndOutInputChange:p}})(),(()=>{const e=[1e3,2e3,5e3,1e4,2e4,5e4],t=["palace","flat","house","bungalow"],o=["12:00","13:00","14:00"],n=["12:00","13:00","14:00"],r=["wifi","dishwasher","parking","washer","elevator","conditioner"],i=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"];window.data={createAdverts:a=>{const d=[];for(let s=0;s<a;s++){const a=window.util.getRandomInteger(window.pin.PinCoordinateLimit.MIN_X,window.pin.PinCoordinateLimit.MAX_X),c=window.util.getRandomInteger(window.pin.PinCoordinateLimit.MIN_Y,window.pin.PinCoordinateLimit.MAX_Y);d.push({author:{avatar:"img/avatars/user0"+[s+1]+".png"},offer:{title:window.util.getRandomTitle(),address:a+", "+c,price:window.util.getRandomValue(e),type:window.util.getRandomValue(t),rooms:window.util.getRandomInteger(1,5),guests:window.util.getRandomInteger(1,20),checkin:window.util.getRandomValue(o),checkout:window.util.getRandomValue(n),features:window.util.getRandomArray(r),description:"строка с описанием",photos:window.util.getRandomArray(i)},location:{x:a,y:c}})}return d}}})(),(()=>{const e={MIN_X:300,MAX_X:1100,MIN_Y:130,MAX_Y:630,Y_OFFSET:-70,X_OFFSET:-25},t=document.querySelector("#pin").content.querySelector(".map__pin"),o=o=>{const n=t.cloneNode(!0);n.style.left=o.location.x+e.X_OFFSET+"px",n.style.top=o.location.y+e.Y_OFFSET+"px",n.children[0].src=o.author.avatar,n.children[0].alt=o.offer.title;const r=()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),n.classList.add("map__pin--active")},i=()=>{window.card.openCard(o),r()};return n.addEventListener("click",(()=>{window.card.openCard(o),r()})),n.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,i)})),n};window.pin={PinCoordinateLimit:e,createPin:o,renderPins:(e,t)=>{t.forEach((t=>{e.appendChild(o(t))}))},removePins:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=45,t=40,o="Фотография жилья",n={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=(e,t,o)=>(e?t[o]=e:t.setAttribute("style","display: none"),t),i=document.querySelector("#card").content.querySelector(".map__card");window.card={openCard:e=>{const t=document.querySelector(".map"),o=t.querySelector(".map__card");o&&o.remove(),window.card.renderCard(t,e)},renderCard:(a,d)=>{const s=document.querySelector(".map__filters-container");d&&a.insertBefore((a=>{const d=i.cloneNode(!0);r(a.author.avatar,d.querySelector(".popup__avatar"),"src"),r(a.offer.title,d.querySelector(".popup__title"),"textContent"),r(a.offer.address,d.querySelector(".popup__text--address"),"textContent");const s=a.offer.price?a.offer.price+"₽/ночь":"";r(s,d.querySelector(".popup__text--price"),"textContent"),r(n[a.offer.type],d.querySelector(".popup__type"),"textContent");const c=a.offer.rooms&&a.offer.guests?a.offer.rooms+" комнаты для "+a.offer.guests+" гостей":"";r(c,d.querySelector(".popup__text--capacity"),"textContent");const l=a.offer.checkin&&a.offer.checkout?"Заезд после "+a.offer.checkin+", выезд до "+a.offer.checkout:"";r(l,d.querySelector(".popup__text--time"),"textContent"),r(a.offer.description,d.querySelector(".popup__description"),"textContent"),((e,t)=>{e?(t.innerHTML="",e.forEach((e=>{const o=document.createElement("li");o.classList.add("popup__feature","popup__feature--"+e),t.appendChild(o)}))):t.setAttribute("style","display: none")})(a.offer.features,d.querySelector(".popup__features")),((n,r)=>{n?(r.innerHTML="",n.forEach((n=>{const i=document.createElement("img");i.classList.add("popup__photo"),i.setAttribute("src",n),i.setAttribute("width",e),i.setAttribute("height",t),i.setAttribute("alt",o),r.appendChild(i)}))):r.setAttribute("style","display: none")})(a.offer.photos,d.querySelector(".popup__photos"));const u=d.querySelector(".popup__close"),m=function(){d.remove(),u.removeEventListener("click",w),document.removeEventListener("keydown",p)},p=e=>{window.util.isEscEvent(e,m)},w=()=>{m()};return u.addEventListener("click",w),document.addEventListener("keydown",p),d})(d),s)},removeCard:()=>{const e=document.querySelector(".map__card");e&&e.remove()}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__pin--main"),n=0-window.util.MainPinParam.WIDTH/2,r=t.clientWidth-window.util.MainPinParam.WIDTH/2,i=130-window.util.MainPinParam.HEIGHT,a=630-window.util.MainPinParam.HEIGHT;o.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY},d=!1;const s=e=>{e.preventDefault(),d=!0;let s=t.x-e.clientX,c=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let l={x:o.offsetLeft-s,y:o.offsetTop-c};var u;(u=l).x<=n&&(u.x=n),u.x>=r&&(u.x=r),u.y<=i&&(u.y=i),u.y>=a&&(u.y=a),o.style.top=l.y+"px",o.style.left=l.x+"px",window.form.setAddressField(window.util.getMainPinCoords())},c=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c),d){const e=t=>{t.preventDefault(),o.removeEventListener("click",e)};o.addEventListener("click",e)}};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),a=t.querySelector("#housing-features"),d=t=>(t=>t.offer.type===o.value||o.value===e)(t)&&(e=>{switch(n.value){case"low":return e.offer.price<1e3;case"middle":return e.offer.price>=1e3&&e.offer.price<=5e4;case"high":return e.offer.price>=5e4}return!0})(t)&&(t=>t.offer.rooms===+r.value||r.value===e)(t)&&(t=>t.offer.guests===+i.value||i.value===e)(t)&&(e=>{const t=a.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))})(t);t.addEventListener("change",(()=>{const e=window.data.filter(d);window.util.clearMap(),window.debounce(window.util.renderData(e))})),window.filter={resetFilters:()=>{t.reset()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__input"),r=document.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{const n=t.files[0];if(e.some((e=>n.name.toLowerCase().endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}})),n.addEventListener("change",(()=>{const t=n.files[0];if(e.some((e=>t.name.toLowerCase().endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img");t.src=e.result,r.innerHTML="",t.alt="Фотография жилья",t.style.maxWidth="70px",t.style.maxHeight="70px",r.append(t)})),e.readAsDataURL(t)}})),window.uploadPhoto={resetImages:()=>{o.src="img/muffin-grey.svg",r.innerHTML=""}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),n=o.children,r=o.querySelector("#room_number"),i=document.querySelector(".map__filters").children,a=e=>{m(e)},d=e=>{m(e)},s=()=>{e.classList.add("map--faded"),o.classList.add("ad-form--disabled"),window.form.deactivateForm(i),window.form.deactivateForm(n),window.form.setAddressField(window.util.getMainPinCoords()),t.addEventListener("mousedown",a),t.addEventListener("keydown",d)};s();const c=()=>{e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),window.form.activateForm(i),window.form.activateForm(n),t.removeEventListener("mousedown",a),t.removeEventListener("keydown",d)},l=(e,t)=>{window.data=t,window.util.isEnterEvent(e,c),window.util.isMouseMainButtonEvent(e,c),window.form.setAddressField(window.util.getMainPinCoords()),window.util.renderData(window.data),window.form.checkRooms(r.value)},u=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: tomato;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="25px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},m=e=>{window.server.loadData(l,u,e)};window.main={deactivatePage:s}})()})();